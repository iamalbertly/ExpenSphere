<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker v0.0.8</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e2e;
            color: #f5f5f5;
            margin: 0;
            padding: 0;
        }
        .container {
            margin: 20px auto;
            width: 90%;
            max-width: 600px;
            background-color: #28293d;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            margin-top: 0;
            color: #f5a623;
        }
        textarea {
            width: 100%;
            height: 120px;
            background-color: #33344b;
            color: #f5f5f5;
            border: none;
            padding: 5px;
            border-radius: 8px;
            font-size: 16px;
            resize: none;
        }
        textarea:focus {
            outline: none;
            border: 2px solid #f5a623;
        }
        button {
            width: 100%;
            padding: 15px;
            background-color: #f5a623;
            color: #1e1e2f;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #d48821;
        }
        .editable-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        .editable-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 0;
        }
        .editable-field.full-width {
            grid-column: 1 / -1;
        }
        .editable-label {
            font-size: 14px;
            margin-bottom: 5px;
            color: #8e8ea0;
        }
        .editable-input, .editable-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background-color: #33344b;
            color: #f5f5f5;
            font-size: 14px;
            height: 36px;
        }
        .editable-input[type="text"] {
            height: 36px;
        }
        .confidence-score {
            grid-column: 1 / -1;
            text-align: right;
            color: #8e8ea0;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f5f5f5;
            border-top: 5px solid #f5a623;  /* Changed to use same color as other accents */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }    /* Animation keyframes */
            100% { transform: rotate(360deg); } /* Animation keyframes */
        }

        /* Error Notification */
        .error-notification {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #ff4444;
            color: white;
            padding: 15px;
            z-index: 1001;
            animation: slideDown 0.5s ease-out;
        }

        .error-notification.show {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .error-content {
            flex-grow: 1;
            margin-right: 20px;
        }

        .error-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .error-message {
            font-size: 14px;
        }

        .error-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }    /* Slide animation */
            to { transform: translateY(0); }          /* Slide animation */
        }

        .version {
            font-size: 14px;
            color: #f5a623;
            margin-left: 10px;
            opacity: 0.8;
        }

        /* Mobile optimization styles */
        @media screen and (max-width: 768px) {
            body {
                background-color: #28293d;
            }
            .container {
                margin: 0;
                width: 90%;
                max-width: 90%;
                min-height: 100vh;
                border-radius: 0;
                box-shadow: none;
                padding: 15px;
            }
            .input-section {
                padding: 15px;
            }
            .input-section textarea {
                height: 60px;
            }
            .results-section {
                padding: 0;
            }
            .editable-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="error-notification">
        <div class="error-content">
            <div class="error-title">Error Occurred</div>
            <div class="error-message"></div>
        </div>
        <button class="error-close" onclick="closeError()">Ã—</button>
    </div>
    <div class="container">
        <h1>Expense Tracker <span class="version">v0.0.7</span></h1>
        <div class="results-section">
            <div class="editable-container" id="editableContainer"></div>
        </div>
        <div class="input-section">
            <textarea id="inputText" placeholder="Type your expense description and press Enter..."></textarea>
            <button onclick="authorize()">Submit</button>
        </div>
    </div>

    <script type="module">
        import config from './config.js';
        console.log(config.clientId); // Use the client ID as needed
    </script>
    <script>
        /** @const {string} */
        const CLIENT_ID = "__CLIENT_ID__";
        /** @const {string} */
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
        /** @const {string} */
        const SPREADSHEET_ID = "__SPREADSHEET_ID__";

        /** @type {Object} */
        let generatedData = null;
        /** @type {Object} */
        let tokenClient = null;

        const VERSION = {
            major: 0,
            minor: 0,
            patch: 12,
            buildDate: '2024-03-19',
            toString() {
                return `${this.major}.${this.minor}.${this.patch}-${this.buildDate}`;
            }
        };

        const trainingData = [
            { category: "Petrol & Transport", keywords: ["petrol", "raum", "bmw", "fuel"] },
            { category: "Car Maintenance & Fee's", keywords: ["repair", "maintenance", "oil", "service"] }
        ];

        const paidToOptions = [
            "Spent on BMW",
            "Spent on Raum",
            "Gave to Maid (nyumbani)",
            "Gave to Irene",
            "Aaliyah School Fee",
            "ALRADA - Expenses",
            "Gave to Parents - Tina",
            "Spent on Guta",
            "Luku",
            "Msiba",
            "Medical Expenses",
            "Eating Out",
            "Groceries",
            "Petrol & Transport",
            "Car Maintenance & Fee's",
            "Celebration",
            "Gift to Family & Friends",
            "Utilities",
            "Aaliyah Investment",
            "Home Investment",
            "Rent",
            "Personal",
            "Phone Maintenance",
            "Funeral",
            "(OTHER) Food, Transport, Groceries, etc."
        ];

        window.generatedData = null;
        window.tokenClient = null;

        const EVENTS = {
            INPUT: 'input',
            KEYDOWN: 'keydown',
            LOAD: 'load',
            DOMCONTENTLOADED: 'DOMContentLoaded'
        };

        /* Safe initialization wrapper */
        (function initApp() {
            if (document.readyState === 'loading') {
                document.addEventListener(EVENTS.DOMCONTENTLOADED, setupApp);
            } else {
                setupApp();
            }
        })();

        function setupApp() {
            const savedVersion = localStorage.getItem('expenseTrackerVersion');
            if (savedVersion) {
                const [major, minor, patch] = savedVersion.split('.').map(Number);
                VERSION.major = major;
                VERSION.minor = minor;
                VERSION.patch = patch;
            }
            
            updateVersion();
            setupEventListeners();
        }

        function processInput() {
            const inputText = document.getElementById("inputText").value.toLowerCase();
            if (inputText.trim() === "") {
                return;
            }

            let maxScore = 0;
            let bestMatch = "Other";

            trainingData.forEach(function(data) {
                const score = calculateMatchScore(inputText, data.keywords);
                if (score > maxScore) {
                    maxScore = score;
                    bestMatch = data.category;
                }
            });

            window.generatedData = {
                "Date of Transaction": new Date().toISOString().split("T")[0],
                "Where did the money come from?": "ALBERT",
                "How much money? (Tsh)": "0",
                "What's the Purchase Category": bestMatch,
                "Purchase Description": inputText,
                "Where was the money payed to?": "",
                "Confidance level": Math.round(maxScore * 100) + "%"
            };

            displayEditableFields(window.generatedData);
        }

        function displayEditableFields(data) {
            const container = document.getElementById("editableContainer");
            container.innerHTML = ``;

            /* Date Field */
            const dateField = document.createElement("div");
            dateField.className = "editable-field";
            dateField.innerHTML = `
                <label class="editable-label">Date</label>
                <input type="date" class="editable-input" value="${data["Date of Transaction"]}" onchange="updateField('Date of Transaction', this.value)">
            `;
            container.appendChild(dateField);

            /* Amount Field */
            const amountField = document.createElement("div");
            amountField.className = "editable-field";
            amountField.innerHTML = `
                <label class="editable-label">Amount (Tsh)</label>
                <input type="number" class="editable-input" value="${data["How much money? (Tsh)"]}" onchange="updateField('How much money? (Tsh)', this.value)">
            `;
            container.appendChild(amountField);

            /* Category Field */
            const categoryField = document.createElement("div");
            categoryField.className = "editable-field";
            const options = trainingData.map(function(entry) { return '<option value="' + entry.category + '" ' + (entry.category === data["What's the Purchase Category"] ? "selected" : "") + '>' + entry.category + '</option>'; }).join("");
            categoryField.innerHTML = `
                <label class="editable-label">Category</label>
                <select class="editable-select" onchange="updateField('What\'s the Purchase Category', this.value)">
                    ${options}
                </select>
            `;
            container.appendChild(categoryField);

            /* Paid To Field */
            const paidToField = document.createElement("div");
            paidToField.className = "editable-field";
            const paidToOptionsHtml = paidToOptions
                .map(option => `<option value="${option}" ${option === data["Where was the money payed to?"] ? "selected" : ""}>${option}</option>`)
                .join("");
            paidToField.innerHTML = `
                <label class="editable-label">Paid To</label>
                <select class="editable-select" onchange="updateField('Where was the money payed to?', this.value)">
                    ${paidToOptionsHtml}
                </select>
            `;
            container.appendChild(paidToField);

            /* Description Field (now as text input) */
            const descriptionField = document.createElement("div");
            descriptionField.className = "editable-field full-width";
            descriptionField.innerHTML = `
                <label class="editable-label">Description</label>
                <input type="text" class="editable-input" value="${data["Purchase Description"]}" onchange="updateField('Purchase Description', this.value)">
            `;
            container.appendChild(descriptionField);

            /* Confidence Score */
            const confidenceField = document.createElement("div");
            confidenceField.className = "confidence-score";
            confidenceField.innerHTML = `Confidence Score: ${data["Confidance level"]}`;
            container.appendChild(confidenceField);
        }

        window.updateField = function(field, value) {
            window.generatedData[field] = value;
        }

        /* Function to check if stored token is still valid */
        function isTokenValid(token) {
            if (!token) return false;
            
            return fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/ExpenseResults!A1`,
                {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                }
            )
            .then(response => response.ok)
            .catch(() => false);
        }

        /* Function to handle the token storage */
        function storeToken(token) {
            localStorage.setItem('expenseTrackerToken', token);
            localStorage.setItem('tokenTimestamp', new Date().getTime());
        }

        /* Function to get stored token */
        function getStoredToken() {
            return localStorage.getItem('expenseTrackerToken');
        }

        /* Function to clear stored token */
        function clearStoredToken() {
            localStorage.removeItem('expenseTrackerToken');
            localStorage.removeItem('tokenTimestamp');
        }

        /* Modified authorize function */
        window.authorize = async function() {
            const storedToken = getStoredToken();
            
            if (storedToken) {
                /* Check if stored token is still valid */
                const isValid = await isTokenValid(storedToken);
                if (isValid) {
                    submitData(storedToken);
                    return;
                } else {
                    clearStoredToken();
                }
            }

            /* If no valid token, request new one */
            window.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthResponse
            });
            window.tokenClient.requestAccessToken();
        }

        async function handleAuthResponse(response) {
            if (response.error) {
                console.error("OAuth Error:", response);
                alert(`Authorization failed: ${response.error}. Please try again.`);
                clearStoredToken();
                return;
            }
            
            /* Store the new token */
            storeToken(response.access_token);
            await submitData(response.access_token);
        }

        function showLoading() {
            document.querySelector('.loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
        }

        function showError(title, message, details) {
            const notification = document.querySelector('.error-notification');
            notification.querySelector('.error-title').textContent = title;
            notification.querySelector('.error-message').innerHTML = `
                <p>${message}</p>
                ${details ? `<p><strong>Details:</strong> ${details}</p>` : ''}
                ${message.includes('Authentication') ? '<p><strong>Solution:</strong> Please try submitting again to re-authenticate.</p>' : ''}
                ${message.includes('permission') ? '<p><strong>Solution:</strong> Please ensure you have edit access to the spreadsheet.</p>' : ''}
            `;
            notification.classList.add('show');
        }

        window.closeError = function() {
            document.querySelector('.error-notification').classList.remove('show');
        }

        /* Modify the updateVersion function to also update the document title */
        function updateVersion(type = 'patch') {
            switch(type) {
                case 'major':
                    VERSION.major++;
                    VERSION.minor = 0;
                    VERSION.patch = 0;
                    break;
                case 'minor':
                    VERSION.minor++;
                    VERSION.patch = 0;
                    break;
                case 'patch':
                    VERSION.patch++;
                    break;
            }
            
            /* Update version display in UI and document title */
            const versionString = `v${VERSION.toString()}`;
            document.title = `Expense Tracker ${versionString}`;
            const versionElements = document.querySelectorAll('.version');
            versionElements.forEach(function(el) {
                el.textContent = versionString;
            });

            /* Store version in localStorage */
            localStorage.setItem('expenseTrackerVersion', VERSION.toString());
        }

        /* Update the DOMContentLoaded event listener to also set the initial title */
        document.addEventListener('DOMContentLoaded', function initApp() {
            const savedVersion = localStorage.getItem('expenseTrackerVersion');
            if (savedVersion) {
                const [major, minor, patch] = savedVersion.split('.').map(Number);
                VERSION.major = major;
                VERSION.minor = minor;
                VERSION.patch = patch;
            }
            
            const versionString = `v${VERSION.toString()}`;
            document.title = `Expense Tracker ${versionString}`;
            const versionElements = document.querySelectorAll('.version');
            versionElements.forEach(function(el) {
                el.textContent = versionString;
            });
        });

        /* Modify the submitData function to increment patch version on successful submission */
        async function submitData(token) {
            showLoading();
            const values = [
                [
                    window.generatedData["Date of Transaction"],
                    window.generatedData["Where did the money come from?"],
                    window.generatedData["How much money? (Tsh)"],
                    window.generatedData["What's the Purchase Category"],
                    window.generatedData["Purchase Description"],
                    window.generatedData["Where was the money payed to?"],
                    window.generatedData["Confidance level"]
                ]
            ];

            try {
                /* First, get the last row with data */
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/ExpenseResults!A:G`,
                    {
                        headers: {
                            Authorization: `Bearer ${token}`,
                        },
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch current data: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                const lastRow = data.values ? data.values.length + 1 : 1;
                const range = `ExpenseResults!A${lastRow}`;

                /* Now append the data to the exact row */
                const submitResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=USER_ENTERED`,
                    {
                        method: "PUT",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            range: range,
                            values: values,
                        }),
                    }
                );

                if (!submitResponse.ok) {
                    const errorText = await submitResponse.text();
                    throw new Error(`Failed to submit data: ${submitResponse.status} - ${errorText}`);
                }

                await submitResponse.json();
                hideLoading();
                alert("Data submitted successfully!");
                document.getElementById("inputText").value = "";
                document.getElementById("editableContainer").innerHTML = "";
                
                /* Increment patch version after successful submission */
                updateVersion('patch');

            } catch (error) {
                hideLoading();
                window.console && console.error("Detailed error:", error);
                let errorTitle = "Submission Failed";
                let errorMessage = "An error occurred while submitting your data.";
                let errorDetails = error.message || '';

                if (error.message.includes("401")) {
                    errorTitle = "Authentication Error";
                    errorMessage = "Your session has expired or is invalid.";
                    clearStoredToken();
                } else if (error.message.includes("403")) {
                    errorTitle = "Permission Denied";
                    errorMessage = "You don't have permission to access this spreadsheet.";
                } else if (error.message.includes("404")) {
                    errorTitle = "Spreadsheet Not Found";
                    errorMessage = "The target spreadsheet could not be found.";
                }

                showError(errorTitle, errorMessage, errorDetails);
            }
        }

        /* Declare all functions that might be minified */
        const FUNCTIONS = {
            processInput,
            authorize,
            updateField,
            closeError,
            showError,
            hideLoading,
            showLoading,
            updateVersion,
            submitData,
            handleAuthResponse,
            displayEditableFields,
            isTokenValid,
            storeToken,
            getStoredToken,
            clearStoredToken
        };

        /* Make functions globally available */
        Object.assign(window, FUNCTIONS);

        ;(function(window, document, undefined) {
            'use strict';

            // Export necessary functions to global scope
            Object.assign(window, {
                authorize: authorize,
                closeError: closeError,
                updateField: updateField,
                processInput: processInput
            });

        })(window, document);
    </script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</body>
</html>
