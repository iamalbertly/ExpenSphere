<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e2e;
            color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            align-self: flex-start;
            width: 90%;
            max-width: 600px;
            background-color: #28293d;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            margin-top: 0;
            color: #f5a623;
        }
        textarea {
            width: 100%;
            height: 120px;
            background-color: #33344b;
            color: #f5f5f5;
            border: none;
            padding: 5px;
            border-radius: 8px;
            font-size: 16px;
            resize: none;
        }
        textarea:focus {
            outline: none;
            border: 2px solid #f5a623;
        }
        button {
            width: 100%;
            padding: 15px;
            background-color: #f5a623;
            color: #1e1e2f;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #d48821;
        }
        .editable-container {
            margin: 20px 0;
        }
        .editable-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .editable-label {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .editable-input, .editable-select {
            padding: 10px;
            border-radius: 8px;
            border: none;
            background-color: #33344b;
            color: #f5f5f5;
            font-size: 14px;
        }
        .editable-input:focus, .editable-select:focus {
            outline: 2px solid #f5a623;
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f5f5f5;
            border-top: 5px solid #f5a623;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error Notification */
        .error-notification {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #ff4444;
            color: white;
            padding: 15px;
            z-index: 1001;
            animation: slideDown 0.5s ease-out;
        }

        .error-notification.show {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .error-content {
            flex-grow: 1;
            margin-right: 20px;
        }

        .error-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .error-message {
            font-size: 14px;
        }

        .error-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    <div class="error-notification">
        <div class="error-content">
            <div class="error-title">Error Occurred</div>
            <div class="error-message"></div>
        </div>
        <button class="error-close" onclick="closeError()">Ã—</button>
    </div>
    <div class="container">
        <h1>Expense Tracker</h1>
        <textarea id="inputText" placeholder="Type your expense description and press Enter..."></textarea>
        <button onclick="authorize()">Submit</button>
        <div class="editable-container" id="editableContainer"></div>
        <div class="confidence" id="confidence">Confidence Score: 0%</div>
    </div>

    <script>
        const CLIENT_ID = "35324134118-oit317sdim38b1h0pbmje25j8dfs10jo.apps.googleusercontent.com";
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
        const SPREADSHEET_ID = "1dagJ19LGKdGy1o_uD2Ggsyi2kt8PhTyVXfufO4A55eA";

        const trainingData = [
            { category: "Petrol & Transport", keywords: ["petrol", "raum", "bmw", "fuel"] },
            { category: "Car Maintenance & Fee's", keywords: ["repair", "maintenance", "oil", "service"] },
            { category: "Groceries", keywords: ["milk", "groceries", "maid", "shopping"] },
            { category: "Gift to Family & Friends", keywords: ["gift", "donation", "contribution", "help", "irene"] },
            { category: "Utilities", keywords: ["luku", "electricity", "water", "gas", "trash"] },
            { category: "Eating Out", keywords: ["food", "restaurant", "chips", "lunch"] },
            { category: "Medical & Medicine", keywords: ["hospital", "medicine", "doctor"] },
            { category: "Aaliyah Investment", keywords: ["aaliyah", "school", "karate", "hair"] },
            { category: "Celebration", keywords: ["anniversary", "party", "event"] },
            { category: "(OTHER) Food, Transport, Groceries, etc.", keywords: ["miscellaneous", "unknown"] }
        ];

        const paidToOptions = [
            "Spent on BMW",
            "Spent on Raum",
            "Gave to Maid (nyumbani)",
            "Gave to Irene",
            "Aaliyah School Fee",
            "ALRADA - Expenses",
            "Gave to Parents - Tina",
            "Spent on Guta",
            "Luku",
            "Msiba",
            "Medical Expenses",
            "Eating Out",
            "Groceries",
            "Petrol & Transport",
            "Car Maintenance & Fee's",
            "Celebration",
            "Gift to Family & Friends",
            "Utilities",
            "Aaliyah Investment",
            "Home Investment",
            "Rent",
            "Personal",
            "Phone Maintenance",
            "Funeral",
            "(OTHER) Food, Transport, Groceries, etc."
        ];

        let tokenClient;
        let generatedData = {};

        document.getElementById("inputText").addEventListener("input", processInput);
        document.getElementById("inputText").addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                authorize();
            }
        });

        function processInput() {
            const input = document.getElementById("inputText").value.toLowerCase();
            const amountMatch = input.match(/(\d{1,3}(?:,\d{3})*|[0-9]+)\s?k/i);
            const amount = amountMatch ? parseInt(amountMatch[1].replace(/,/g, '')) * (amountMatch[0].includes('k') ? 1000 : 1) : null;

            let category = "(OTHER) Food, Transport, Groceries, etc.";
            let matchedKeywords = [];
            let totalKeywords = 0;

            for (const { category: cat, keywords } of trainingData) {
                const matches = keywords.filter(keyword => input.includes(keyword));
                if (matches.length > 0 && matches.length > matchedKeywords.length) {
                    category = cat;
                    matchedKeywords = matches;
                    totalKeywords = keywords.length;
                }
            }

            const score = matchedKeywords.length > 0 ? Math.round((matchedKeywords.length / totalKeywords) * 100) : 0;

            // Try to determine the best matching paidTo option based on the input and category
            let paidTo = "(OTHER) Food, Transport, Groceries, etc.";
            for (const option of paidToOptions) {
                const optionLower = option.toLowerCase();
                if (input.includes(optionLower) || category.toLowerCase().includes(optionLower)) {
                    paidTo = option;
                    break;
                }
            }

            generatedData = {
                "Date of Transaction": new Date().toISOString().split("T")[0],
                "Where did the money come from?": "ALBERT",
                "How much money? (Tsh)": amount || "Unknown",
                "What's the Purchase Category": category,
                "Purchase Description": input,
                "Where was the money payed to?": paidTo,
                "Confidance level": `${score}%`
            };

            displayEditableFields(generatedData);
            document.getElementById("confidence").textContent = `Confidence Score: ${score}%`;
        }

        function displayEditableFields(data) {
            const container = document.getElementById("editableContainer");
            container.innerHTML = "";

            // Date Field
            const dateField = document.createElement("div");
            dateField.className = "editable-field";
            dateField.innerHTML = `
                <label class="editable-label">Date of Transaction</label>
                <input type="date" class="editable-input" value="${data["Date of Transaction"]}" onchange="updateField('Date of Transaction', this.value)">
            `;
            container.appendChild(dateField);

            // Category Field
            const categoryField = document.createElement("div");
            categoryField.className = "editable-field";
            const options = trainingData.map(entry => `<option value="${entry.category}" ${entry.category === data["What's the Purchase Category"] ? "selected" : ""}>${entry.category}</option>`).join("");
            categoryField.innerHTML = `
                <label class="editable-label">What's the Purchase Category</label>
                <select class="editable-select" onchange="updateField('What\'s the Purchase Category', this.value)">
                    ${options}
                </select>
            `;
            container.appendChild(categoryField);

            // Description Field
            const descriptionField = document.createElement("div");
            descriptionField.className = "editable-field";
            descriptionField.innerHTML = `
                <label class="editable-label">Purchase Description</label>
                <textarea class="editable-input" onchange="updateField('Purchase Description', this.value)" rows="3">${data["Purchase Description"]}</textarea>
            `;
            container.appendChild(descriptionField);

            // Amount Field
            const amountField = document.createElement("div");
            amountField.className = "editable-field";
            amountField.innerHTML = `
                <label class="editable-label">How much money? (Tsh)</label>
                <input type="number" class="editable-input" value="${data["How much money? (Tsh)"]}" onchange="updateField('How much money? (Tsh)', this.value)">
            `;
            container.appendChild(amountField);

            // Paid To Field as Select
            const paidToField = document.createElement("div");
            paidToField.className = "editable-field";
            const paidToOptionsHtml = paidToOptions
                .map(option => `<option value="${option}" ${option === data["Where was the money payed to?"] ? "selected" : ""}>${option}</option>`)
                .join("");
            paidToField.innerHTML = `
                <label class="editable-label">Where was the money payed to?</label>
                <select class="editable-select" onchange="updateField('Where was the money payed to?', this.value)">
                    ${paidToOptionsHtml}
                </select>
            `;
            container.appendChild(paidToField);

            // Confidence Score (Read-only)
            const confidenceField = document.createElement("div");
            confidenceField.className = "editable-field";
            confidenceField.innerHTML = `
                <label class="editable-label">Confidance level</label>
                <input type="text" class="editable-input" value="${data["Confidance level"]}" readonly>
            `;
            container.appendChild(confidenceField);
        }

        function updateField(field, value) {
            generatedData[field] = value;
        }

        // Function to check if stored token is still valid
        function isTokenValid(token) {
            if (!token) return false;
            
            return fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/ExpenseResults!A1`,
                {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                }
            )
            .then(response => response.ok)
            .catch(() => false);
        }

        // Function to handle the token storage
        function storeToken(token) {
            localStorage.setItem('expenseTrackerToken', token);
            localStorage.setItem('tokenTimestamp', new Date().getTime());
        }

        // Function to get stored token
        function getStoredToken() {
            return localStorage.getItem('expenseTrackerToken');
        }

        // Function to clear stored token
        function clearStoredToken() {
            localStorage.removeItem('expenseTrackerToken');
            localStorage.removeItem('tokenTimestamp');
        }

        // Modified authorize function
        async function authorize() {
            const storedToken = getStoredToken();
            
            if (storedToken) {
                // Check if stored token is still valid
                const isValid = await isTokenValid(storedToken);
                if (isValid) {
                    submitData(storedToken);
                    return;
                } else {
                    clearStoredToken();
                }
            }

            // If no valid token, request new one
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthResponse
            });
            tokenClient.requestAccessToken();
        }

        function handleAuthResponse(response) {
            if (response.error) {
                console.error("OAuth Error:", response);
                alert(`Authorization failed: ${response.error}. Please try again.`);
                clearStoredToken();
                return;
            }
            
            // Store the new token
            storeToken(response.access_token);
            submitData(response.access_token);
        }

        function showLoading() {
            document.querySelector('.loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
        }

        function showError(title, message, details) {
            const notification = document.querySelector('.error-notification');
            notification.querySelector('.error-title').textContent = title;
            notification.querySelector('.error-message').innerHTML = `
                <p>${message}</p>
                ${details ? `<p><strong>Details:</strong> ${details}</p>` : ''}
                ${message.includes('Authentication') ? '<p><strong>Solution:</strong> Please try submitting again to re-authenticate.</p>' : ''}
                ${message.includes('permission') ? '<p><strong>Solution:</strong> Please ensure you have edit access to the spreadsheet.</p>' : ''}
            `;
            notification.classList.add('show');
        }

        function closeError() {
            document.querySelector('.error-notification').classList.remove('show');
        }

        async function submitData(token) {
            showLoading();
            const values = [
                [
                    generatedData["Date of Transaction"],
                    generatedData["Where did the money come from?"],
                    generatedData["How much money? (Tsh)"],
                    generatedData["What's the Purchase Category"],
                    generatedData["Purchase Description"],
                    generatedData["Where was the money payed to?"],
                    generatedData["Confidance level"]
                ]
            ];

            try {
                // First, get the last row with data
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/ExpenseResults!A:G`,
                    {
                        headers: {
                            Authorization: `Bearer ${token}`,
                        },
                    }
                );

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Failed to fetch current data: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                const lastRow = data.values ? data.values.length + 1 : 1;
                const range = `ExpenseResults!A${lastRow}`;

                // Now append the data to the exact row
                const submitResponse = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=USER_ENTERED`,
                    {
                        method: "PUT",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            range: range,
                            values: values,
                        }),
                    }
                );

                if (!submitResponse.ok) {
                    const errorText = await submitResponse.text();
                    throw new Error(`Failed to submit data: ${submitResponse.status} - ${errorText}`);
                }

                await submitResponse.json();
                hideLoading();
                alert("Data submitted successfully!");
                document.getElementById("inputText").value = "";
                document.getElementById("editableContainer").innerHTML = "";
                document.getElementById("confidence").textContent = "Confidence Score: 0%";

            } catch (error) {
                hideLoading();
                console.error("Detailed error:", error);
                let errorTitle = "Submission Failed";
                let errorMessage = "An error occurred while submitting your data.";
                let errorDetails = error.message;

                if (error.message.includes("401")) {
                    errorTitle = "Authentication Error";
                    errorMessage = "Your session has expired or is invalid.";
                    clearStoredToken();
                } else if (error.message.includes("403")) {
                    errorTitle = "Permission Denied";
                    errorMessage = "You don't have permission to access this spreadsheet.";
                } else if (error.message.includes("404")) {
                    errorTitle = "Spreadsheet Not Found";
                    errorMessage = "The target spreadsheet could not be found.";
                }

                showError(errorTitle, errorMessage, errorDetails);
            }
        }
    </script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</body>
</html>
