<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://accounts.google.com https://*.googleapis.com; connect-src 'self' ws://127.0.0.1:* wss://127.0.0.1:* ws://localhost:* wss://localhost:* http://127.0.0.1:* http://localhost:* https://sheets.googleapis.com https://accounts.google.com https://apis.googleapis.com https://*.googleapis.com https://apis.google.com https://raw.githubusercontent.com https://*.githubusercontent.com; style-src 'self' 'unsafe-inline' https://accounts.google.com https://*.googleapis.com; img-src 'self' data: https:; font-src 'self'; frame-src https://accounts.google.com"><title>ExpenSphere v0.0.29</title><script src="https://accounts.google.com/gsi/client" async defer></script><script src="https://apis.google.com/js/api.js" async defer></script><script>window.APP_CONFIG={ clientId: '35324134118-05pg5bahtb5g3p8gm539k45nijlnjdpi.apps.googleusercontent.com', apiKey: 'AIzaSyAh3L8v1pO6i6_2sJ0gPUnAE___jvPL0lU', spreadsheetId: '1dagJ19LGKdGy1o_uD2Ggsyi2kt8PhTyVXfufO4A55eA', scope: 'https://www.googleapis.com/auth/spreadsheets' }; let isInitializing=false; let isInitialized=false; let gisLoaded=false; let gapiLoaded=false; let isLocalhost=window.location.hostname==='localhost' || window.location.hostname==='127.0.0.1' || window.location.hostname===''; console.log(`local: ${isLocalhost}`); if (isLocalhost){ window.APP_CONFIG.clientId='35324134118-05pg5bahtb5g3p8gm539k45nijlnjdpi.apps.googleusercontent.com'; } else{ window.APP_CONFIG.clientId='35324134118-oit317sdim38b1h0pbmje25j8dfs10jo.apps.googleusercontent.com'; } function loadScript(src){ return new Promise((resolve, reject)=>{ if (document.querySelector(`script[src="${src}"]`)){ console.log(`Script ${src} already loaded`); resolve(); return;} const script=document.createElement('script'); script.src=src; script.async=true; script.defer=true; script.onload=()=>resolve(); script.onerror=()=>reject(new Error(`Failed to load script: ${src}`)); document.head.appendChild(script);});} async function initializeGapiClient(){ return new Promise((resolve, reject)=>{ let timeoutId=setTimeout(()=>{ reject(new Error('GIS client initialization timed out'));}, 5000); gapi.load('client:auth2', async ()=>{ try{ console.log('Initializing GAPI client...'); await gapi.client.init({ clientId: window.APP_CONFIG.clientId, scope: window.APP_CONFIG.scope, apiKey: window.APP_CONFIG.apiKey, discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']}); gapi.auth2.getAuthInstance().signIn().then( (googleUser)=>{ clearTimeout(timeoutId); const id_token=googleUser.getAuthResponse().id_token; if (id_token){ console.log('GIS client initialized and token received'); gapi.client.setToken({id_token}); //Use id_token instead of access_token isInitialized=true; resolve();} else{ console.error('Failed to get ID token'); reject(new Error('Failed to get ID token'));}}, (error)=>{ clearTimeout(timeoutId); console.error('Authentication error', error); reject(new Error('Authentication failed'));} ); gapiLoaded=true; resolve();} catch (error){ console.error('Failed to initialize GAPI client:', error); reject(error);}});});} async function initGIS(){ let retries=0; const maxRetries=3; const retryDelay=2000; return new Promise((resolve, reject)=>{ const attemptInit=()=>{ const timeoutId=setTimeout(()=>{ console.error('GIS initialization timed out'); showError('Authentication Error', 'GIS Initialization timed out.'); reject(new Error('GIS initialization timed out'));}, 10000); try{ if (typeof google==='undefined' || !google.accounts || !google.accounts.oauth2){ console.error('GIS client not yet available'); if (retries < maxRetries){ retries++; console.log(`Retrying GIS initialization (${retries}/${maxRetries})...`); setTimeout(attemptInit, retryDelay);} else{ clearTimeout(timeoutId); console.error('Failed to initialize GIS client after retries'); showError('Authentication Error', 'Failed to initialize GIS client after multiple retries.'); reject(new Error('Failed to initialize GIS client after retries'));} return;} console.log('Initializing GIS client...'); window.gisClient=google.accounts.oauth2.initTokenClient({ client_id: window.APP_CONFIG.clientId, scope: window.APP_CONFIG.scope, ux_mode: 'popup', callback: async (tokenResponse)=>{ clearTimeout(timeoutId); if (tokenResponse && tokenResponse.access_token){ console.log('GIS client initialized and token received'); gapi.client.setToken(tokenResponse); isInitialized=true; resolve();} else{ console.error('Failed to get access token', tokenResponse); showError('Authentication Error', `Failed to get access token: ${tokenResponse.error} : ${tokenResponse.error_description}`); reject(new Error('Failed to get access token'));}}, error_callback: (error)=>{ clearTimeout(timeoutId); console.error('GIS client error:', error); showError('Authentication Error', `GIS client error: ${error.message || error}`); reject(error);}}); gisLoaded=true; console.log('GIS client initialization started');} catch (error){ clearTimeout(timeoutId); console.error('Failed to initialize GIS client:', error); showError('Authentication Error', 'Failed to initialize GIS client.'); reject(error);}}; attemptInit();});} async function loadGoogleAPIs(){ try{ await loadScript('https://accounts.google.com/gsi/client'); console.log('GIS client loaded'); await initGIS(); console.log('GIS client initialized'); await loadScript('https://apis.google.com/js/api.js'); console.log('GAPI client loaded'); await initializeGapiClient(); console.log('GAPI client initialized'); console.log('Google APIs and GIS client loaded and initialized');} catch (error){ console.error('Error loading Google APIs:', error); showError('Initialization Error', 'Failed to load Google APIs. Please check your internet connection and try again.'); throw error; }} async function requestGisToken(){ return new Promise((resolve, reject)=>{ try{ if (!window.gisClient){ throw new Error('GIS client not initialized.');} console.log("Requesting access token..."); window.gisClient.requestAccessToken({ prompt: ''}); resolve();} catch (error){ console.error('Error requesting access token:', error); showError('Authentication Error', 'Failed to request access token.'); reject(error);}});} async function handleSignIn(){ return new Promise((resolve)=>{ console.log("Attempting to sign in..."); if (!window.gisClient){ console.error('GIS client is not initialized.'); showError('Authentication Error', 'GIS client is not initialized.'); resolve(false); return;} const timeoutId=setTimeout(()=>{ console.error('Sign-in timed out'); showError('Authentication Error', 'Sign-in process timed out.'); resolve(false);}, 30000); let requestOptions={}; if (window.location.hostname==='localhost' || window.location.hostname==='127.0.0.1'){ requestOptions.prompt='select_account';} else{ requestOptions.prompt=''; } window.gisClient.requestAccessToken(requestOptions, (response)=>{ clearTimeout(timeoutId); if (response.error){ console.error('Sign-in error:', response.error); showError('Authentication Error', `Sign-in failed: ${response.error}`); resolve(false);} else{ console.log('Successfully signed in'); resolve(true);}});});} async function initializeApp(){ if (isInitializing || isInitialized){ console.log('Already initializing or initialized, skipping duplicate call'); return;} isInitializing=true; try{ window.transactions=[]; window.currentTransactionIndex=0; addClearCredentialsButton(); const inputTextArea=document.querySelector('#inputText'); if (!inputTextArea) throw new Error('Input element not found'); const charCounter=document.createElement('div'); charCounter.className='character-count'; inputTextArea.parentNode.appendChild(charCounter); let debounceTimeout=null; inputTextArea.addEventListener('input', (event)=>{ const count=event.target.value.length; charCounter.textContent=`${count} characters`; if (debounceTimeout) clearTimeout(debounceTimeout); debounceTimeout=setTimeout(()=>processInput(), 300);}); const config=await loadConfiguration(); if (!config || !config.clientId || !config.apiKey){ throw new Error('Invalid configuration: Missing required credentials');} console.log('Configuration loaded'); loadGoogleAPIs().then(()=>{ console.log("Google APIs loaded and initialized in the background");}).catch(error=>{ console.error("Error loading Google APIs in the background:", error); showError('API Loading Error', 'Failed to load Google APIs. Please check your internet connection.');}); inputTextArea.focus(); updatePendingBadge(); console.log('App initialization completed');} catch (error){ console.error('Initialization Error:', error); showError('Initialization Error', error.message); throw error;} finally{ isInitializing=false;}} async function initClients(){ try{ await new Promise((resolve, reject)=>{ const checkLoaded=()=>{ if (gapiLoaded && gisLoaded){ resolve();} else{ setTimeout(checkLoaded, 100); }}; checkLoaded();}); window.gisClient=google.accounts.oauth2.initTokenClient({ client_id: window.APP_CONFIG.clientId, scope: window.APP_CONFIG.scope, callback: async (tokenResponse)=>{ if (tokenResponse && tokenResponse.access_token){ console.log('Token received:', tokenResponse); gapi.client.setToken(tokenResponse); isInitialized=true; console.log('Authentication successful'); if (typeof showSuccess==='function'){ showSuccess('Successfully authenticated with Google.');}} else{ console.error('Failed to get access token'); if (typeof showError==='function'){ showError('Authentication Error', 'Failed to get access token.');}}}, error_callback: (error)=>{ console.error('GIS client error:', error); if (typeof showError==='function'){ showError('Authentication Error', 'Failed to initialize GIS client.');}}}); await new Promise((resolve, reject)=>{ window.gisClient.requestAccessToken({ prompt: '', callback: (response)=>{ resolve(response);}, error_callback: (error)=>{ console.error('Error requesting access token:', error); reject(error);}});});} catch (error){ console.error('Error initializing Google API clients:', error); if (typeof showError==='function'){ showError('Initialization Error', 'Failed to initialize Google API clients.');} throw error;}} async function submitTransaction(){ if (!window.transactions || window.transactions.length===0){ showError("No Transaction", "Please enter a transaction first."); return;} try{ showLoading(); if (!isInitialized){ console.log('Application not initialized or user not authenticated, attempting sign in...'); const signedIn=await handleSignIn(); if (!signedIn){ throw new Error('auth_required');}} if (!gapiLoaded || !gisLoaded){ console.log('APIs not fully loaded, waiting...'); await loadGoogleAPIs();} let submittedCount=0; const errors=[]; for (const transaction of window.transactions){ try{ const values=[ [ transaction["Date of Transaction"] || '', transaction["Where did the money come from?"] || '', transaction["How much money? (Tsh)"] || '0', transaction["What's the Purchase Category"] || '', transaction["Purchase Description"] || '', transaction["Where was the money payed to?"] || '', transaction["Confidence level"] || '' ] ]; await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId: window.APP_CONFIG.spreadsheetId, range: 'ExpenseResults!A:G', valueInputOption: 'USER_ENTERED', resource:{ values}}); submittedCount++;} catch (error){ console.error('Failed to submit transaction:', error); errors.push(error);}} if (submittedCount===window.transactions.length){ showSuccess('All transactions submitted successfully'); clearForm();} else if (submittedCount >0){ showWarning('Partial Success', `${submittedCount} out of ${window.transactions.length} transactions submitted. Saving remaining offline.`); for (let i=submittedCount; i < window.transactions.length; i++){ try{ OfflineStorage.savePendingTransaction(window.transactions[i]);} catch (error){ console.error('Failed to save transaction offline:', error);}} updatePendingBadge(); clearForm();} else{ throw new Error('submit_failed');}} catch (error){ console.error('Submit Error:', error); switch (error.message){ case 'auth_required': showError('Authentication Required', 'Please sign in to submit transactions.'); break; case 'token_error': showError('Authentication Error', 'Failed to obtain access token. Please try signing in again.'); break; case 'submit_failed': showError('Submit Error', 'Failed to submit transactions. Saving all offline.'); for (const transaction of window.transactions){ try{ OfflineStorage.savePendingTransaction(transaction);} catch (saveError){ console.error('Failed to save transaction offline:', saveError);}} updatePendingBadge(); break; default: const status=error?.status; if (status===403){ showError('Access Denied', 'You don\'t have permission to modify this spreadsheet.');} else if (status===404){ showError('Spreadsheet Not Found', 'The target spreadsheet could not be found.');} else if (status===429){ showError('Rate Limit Exceeded', 'Too many requests. Please try again later.');} else{ showError('Submit Error', 'An unexpected error occurred. Saving offline.'); if (error.message==='Failed to load Google APIs'){ showError('API Loading Failed', 'Please refresh the page to try again.');} for (const transaction of window.transactions){ try{ OfflineStorage.savePendingTransaction(transaction);} catch (saveError){ console.error('Failed to save transaction offline:', saveError);}} updatePendingBadge();}}} finally{ hideLoading();}} async function loadConfiguration(){ try{ const storedConfig=localStorage.getItem('APP_CONFIG'); if (storedConfig){ window.APP_CONFIG=JSON.parse(storedConfig); console.log('Configuration loaded from localStorage'); return window.APP_CONFIG;} let isLocalhost=window.location.hostname==='localhost' || window.location.hostname==='127.0.0.1' || window.location.hostname===''; console.log(`local: ${isLocalhost}`); if (isLocalhost){ window.APP_CONFIG.clientId='35324134118-05pg5bahtb5g3p8gm539k45nijlnjdpi.apps.googleusercontent.com'; } else{ window.APP_CONFIG.clientId='35324134118-oit317sdim38b1h0pbmje25j8dfs10jo.apps.googleusercontent.com'; } console.log('Using default configuration'); return window.APP_CONFIG;} catch (error){ console.error('Configuration error:', error); throw new Error('Failed to load configuration: ' + error.message);}} function showError(title, message){ console.error('Error:', title, message); const notification=document.querySelector('.error-notification'); if (!notification){ console.error('Error: error-notification element not found'); return;} const titleElement=notification.querySelector('.error-title'); const messageElement=notification.querySelector('.error-message'); if (!titleElement || !messageElement){ console.error('Error: Missing title or message element within error-notification'); return;} titleElement.textContent=title; messageElement.textContent=message; notification.classList.add('show'); setTimeout(()=>{ notification.classList.remove('show');}, 5000);} function showSuccess(message){ const existingNotification=document.querySelector('.success-notification'); if (existingNotification){ existingNotification.remove();} const notification=document.createElement('div'); notification.className='success-notification show'; notification.textContent=message; document.body.appendChild(notification); setTimeout(()=>notification.remove(), 3000);} function closeError(){ const notification=document.querySelector('.error-notification'); if (notification){ notification.classList.remove('show');}} function showInfo(title, message){ const existingNotification=document.querySelector('.info-notification'); if (existingNotification){ existingNotification.remove();} const notification=document.createElement('div'); notification.className='info-notification'; notification.innerHTML=` <div class="info-title">${title}</div><div class="info-message">${message}</div>`; document.body.appendChild(notification); setTimeout(()=>{ notification.remove();}, 5000);} function showWarning(title, message){ const existingNotification=document.querySelector('.warning-notification'); if (existingNotification){ existingNotification.remove();} const notification=document.createElement('div'); notification.className='warning-notification'; notification.innerHTML=` <div class="warning-title">${title}</div><div class="warning-message">${message}</div>`; document.body.appendChild(notification); setTimeout(()=>{ notification.remove();}, 5000);} function clearStoredCredentials(){ localStorage.removeItem('APP_CONFIG'); showSuccess('Credentials cleared. Refresh the page to enter new credentials.');} function addClearCredentialsButton(){ const container=document.querySelector('.container'); if (!container) return; const button=document.createElement('button'); button.className='clear-credentials-button'; button.innerHTML='🔑 Clear Stored Credentials'; button.onclick=clearStoredCredentials; button.style.cssText=` position: fixed; bottom: 20px; right: 20px; padding: 8px 16px; background: var(--bg-input); color: var(--text-light); border: none; border-radius: 8px; cursor: pointer; font-size: 12px; z-index: 1000; `; container.appendChild(button);} function showInitializationError(message){ showError('Initialization Error', message);} async function saveForLater(){ if (!window.transactions || window.transactions.length===0){ showError("No Transaction", "Please enter a transaction first."); return;} let savedCount=0; for (const transaction of window.transactions){ if (OfflineStorage.savePendingTransaction(transaction)){ savedCount++;}} if (savedCount >0){ showSuccess(`${savedCount} transaction${savedCount >1 ? 's' : ''} saved for later`); clearForm();} else{ showError("Save Error", "Failed to save transactions. Please try again.");}} async function saveAllForLater(){ if (!window.transactions || window.transactions.length===0){ showError("No Transactions", "No transactions to save."); return;} let savedCount=0; for (const transaction of window.transactions){ if (OfflineStorage.savePendingTransaction(transaction)){ savedCount++;}} if (savedCount >0){ showSuccess(`${savedCount} transaction${savedCount >1 ? 's' : ''} saved for later`); clearForm(); closeTransactionReview();} else{ showError("Save Error", "Failed to save transactions. Please try again.");}} let loadingCount=0; let loadingTimeout=null; function showLoading(){ loadingCount++; const overlay=document.querySelector('.loading-overlay'); if (overlay && loadingCount >0){ overlay.style.display='flex'; if (loadingTimeout) clearTimeout(loadingTimeout); loadingTimeout=setTimeout(()=>{ if (loadingCount >0){ console.warn('Loading timeout reached, forcing clear'); loadingCount=0; hideLoading();}}, 100000); }} function hideLoading(){ loadingCount=Math.max(0, loadingCount - 1); const overlay=document.querySelector('.loading-overlay'); if (overlay && loadingCount===0){ overlay.style.display='none'; if (loadingTimeout){ clearTimeout(loadingTimeout); loadingTimeout=null;}}} const OfflineStorage={ savePendingTransaction(transaction){ try{ const pending=this.getPendingTransactions(); transaction.id=Date.now().toString(); transaction.savedAt=new Date().toISOString(); pending.push(transaction); localStorage.setItem('pendingTransactions', JSON.stringify(pending)); updatePendingBadge(); return true;} catch (error){ console.error('Save pending transaction error:', error); return false;}}, getPendingTransactions(){ try{ return JSON.parse(localStorage.getItem('pendingTransactions')) || [];} catch{ return [];}}, removePendingTransaction(id){ try{ const pending=this.getPendingTransactions(); const filtered=pending.filter(t=>t.id !==id); localStorage.setItem('pendingTransactions', JSON.stringify(filtered)); updatePendingBadge(); return true;} catch{ return false;}}, clearPendingTransactions(){ localStorage.removeItem('pendingTransactions'); updatePendingBadge();}}; if (document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', initializeApp);} else{ initializeApp();} function processInput(){ const inputText=document.getElementById("inputText").value; const livePreview=document.querySelector('.live-preview'); const collapsibleSection=document.querySelector('.collapsible-section'); try{ if (!inputText.trim()){ document.getElementById("editableContainer").innerHTML=""; transactions=[]; currentTransactionIndex=0; updateTransactionCounter(); livePreview.classList.remove('show'); return;} const analysis=analyzeTextContext(inputText.trim()); livePreview.innerHTML=` <div class="preview-content"><div class="preview-main"><div class="amount-display">${analysis.amount ? analysis.amount.toLocaleString() + ' Tsh' : 'No amount detected'} </div><div class="preview-details"><div class="category-tag"><span class="tag-icon">🏷️</span>${analysis.category} </div><div class="paid-to-tag"><span class="tag-icon">👤</span>${analysis.paidTo} </div></div></div><div class="preview-footer"><div class="confidence-indicator confidence-${getConfidenceLevel(analysis.confidence)}"><span class="confidence-dot"></span>${analysis.confidence}% confident </div><div class="feedback-buttons"><button onclick="provideFeedback(true)" class="feedback-button positive" title="Correct Analysis">✓</button><button onclick="provideFeedback(false)" class="feedback-button negative" title="Incorrect Analysis">✗</button></div></div></div>`; livePreview.classList.add('show'); livePreview.onclick=toggleCollapsible; collapsibleSection.classList.remove('collapsed'); window.currentAnalysis={ input: inputText.trim(), analysis: analysis}; const transaction={ "Date of Transaction": new Date().toISOString().split("T")[0], "Where did the money come from?": "ALBERT", "How much money? (Tsh)": analysis.amount.toString(), "What's the Purchase Category": analysis.category, "Purchase Description": inputText.trim(), "Where was the money payed to?": analysis.paidTo, "Confidence level": `${analysis.confidence}%`}; transactions=[transaction]; currentTransactionIndex=0; displayEditableFields(transaction); updateTransactionCounter();} catch (error){ console.error('Process Input Error:', error); livePreview.innerHTML=`<span style="color: #ff4444;">Error: ${error.message}</span>`; livePreview.classList.add('show');}} function getConfidenceLevel(confidence){ if (confidence >=80) return 'high'; if (confidence >=60) return 'medium'; return 'low';} function analyzeTextContext(text){ const lowerText=text.toLowerCase(); const words=lowerText.split(/\s+/); const amount=extractAmount(lowerText); const scores={ "Groceries & Household": 0, "Gift to Family & Friends": 0, "Petrol & Transport": 0, "Medical & Medicine": 0, "Utilities & Bills": 0, "Eating Out & Entertainment": 0}; words.forEach(word=>{ if (['home', 'maid', 'nyumbani', 'groceries', 'food', 'milk', 'rice'].includes(word)){ scores["Groceries & Household"] +=1;} if (['gave', 'irene', 'gift', 'send', 'support'].includes(word)){ scores["Gift to Family & Friends"] +=1;} if (['petrol', 'fuel', 'transport', 'fare', 'taxi'].includes(word)){ scores["Petrol & Transport"] +=1;}}); let bestCategory="(OTHER) Food, Transport, Groceries, etc."; let highestScore=0; Object.entries(scores).forEach(([category, score])=>{ if (score >highestScore){ highestScore=score; bestCategory=category;}}); const confidence=Math.min(Math.round((highestScore / words.length) * 100) + 50); return{ category: bestCategory, confidence: confidence, amount: amount, paidTo: determinePaidTo(text, bestCategory)};} function determinePaidTo(text, category){ const lowerText=text.toLowerCase(); if (lowerText.includes('irene')) return "Gave to Irene"; if (lowerText.includes('maid') || (lowerText.includes('home') && !lowerText.includes('irene'))){ return "Gave to Maid (nyumbani)";} const defaults={ "Groceries & Household": "Gave to Maid (nyumbani)", "Gift to Family & Friends": "Gave to Irene", "Petrol & Transport": "Spent on Raum"}; return defaults[category] || "(OTHER) Food, Transport, Groceries, etc.";} function extractAmount(text){ const patterns=[ /(\d+)\s*k\b/i, /(\d+)\s*thousand\b/i, /(\d+),(\d{3})/, /(\d+)\s*tsh/i, /(\d+)/ ]; for (const pattern of patterns){ const match=text.match(pattern); if (match){ let amount=parseInt(match[1]); if (pattern.toString().includes('k') || pattern.toString().includes('thousand')){ amount *=1000;} return amount;}} return 0;} function displayEditableFields(data){ if (!data) return; const container=document.getElementById("editableContainer"); if (!container) return; container.innerHTML=''; const fields=[ { field: "Date of Transaction", fullWidth: false}, { field: "How much money? (Tsh)", fullWidth: false}, { field: "What's the Purchase Category", fullWidth: true}, { field: "Where was the money payed to?", fullWidth: true}, { field: "Purchase Description", fullWidth: true}, { field: "Confidence level", fullWidth: false} ]; fields.forEach(({ field, fullWidth})=>{ const fieldDiv=document.createElement("div"); fieldDiv.className=`editable-field${fullWidth ? ' full-width' : ''}`; fieldDiv.onclick=()=>ModalManager.showEditModal(field, data[field]); const label=document.createElement("div"); label.className="editable-label"; label.textContent=field; const value=document.createElement("div"); value.className="editable-value"; value.textContent=data[field] || ''; fieldDiv.appendChild(label); fieldDiv.appendChild(value); container.appendChild(fieldDiv);});} function processAndReview(){ processInput(); if (transactions.length >0){ showTransactionReview();}} function showTransactionReview(){ if (transactions.length===0){ showError("No Transactions", "Please enter a transaction first."); return;} const modal=document.createElement('div'); modal.className='edit-modal show'; modal.style.maxWidth='800px'; modal.innerHTML=` <h3>Review Transaction${transactions.length >1 ? 's' : ''}</h3><div class="transaction-review">${transactions.map((t, i)=>` <div class="transaction-card"><div class="transaction-header"><span class="transaction-amount">${parseInt(t["How much money? (Tsh)"]).toLocaleString()} Tsh</span><span class="confidence-badge">${t["Confidence level"]}</span></div><div class="transaction-details"><div class="transaction-field"><span class="field-label">Category</span><span class="field-value">${t["What's the Purchase Category"]}</span></div><div class="transaction-field"><span class="field-label">Paid To</span><span class="field-value">${t["Where was the money payed to?"]}</span></div><div class="transaction-field"><span class="field-label">Description</span><span class="field-value">${t["Purchase Description"]}</span></div></div><div class="transaction-actions"><button onclick="editTransaction(${i})" class="action-button secondary"><span class="button-icon">✏️</span>Edit </button><button onclick="removeTransaction(${i})" class="action-button danger"><span class="button-icon">🗑️</span>Remove </button></div></div>`).join('')} </div><div class="modal-footer"><div class="total-amount">Total: ${transactions.reduce((sum, t)=>sum + parseInt(t["How much money? (Tsh)"]), 0).toLocaleString()} Tsh </div><div class="modal-actions"><button onclick="submitOnline()" class="action-button primary"><span class="button-icon">📤</span>Submit Online </button><button onclick="saveAllForLater()" class="action-button secondary"><span class="button-icon">💾</span>Save for Later </button><button onclick="closeTransactionReview()" class="action-button secondary">Close</button></div></div>`; document.body.appendChild(modal); const overlay=document.querySelector('.edit-overlay'); overlay.classList.add('show');} function showPendingTransactions(){ const pending=OfflineStorage.getPendingTransactions(); if (pending.length===0){ showError("No Pending Transactions", "There are no transactions saved for later submission."); return;} const groupedByDate=pending.reduce((groups, t)=>{ const date=t["Date of Transaction"]; if (!groups[date]) groups[date]=[]; groups[date].push(t); return groups;},{}); const modal=document.createElement('div'); modal.className='edit-modal show'; modal.style.maxWidth='800px'; modal.innerHTML=` <h3>Saved Transactions (${pending.length})</h3><div class="transaction-review">${Object.entries(groupedByDate).map(([date, transactions])=>` <div class="date-group"><button class="date-header" onclick="toggleDateGroup(this)"><span class="date">${new Date(date).toLocaleDateString()}</span><span class="count">${transactions.length} transaction${transactions.length >1 ? 's' : ''}</span><span class="total">${transactions.reduce((sum, t)=>sum + parseInt(t["How much money? (Tsh)"]), 0).toLocaleString()} Tsh</span></button><div class="date-transactions">${transactions.map(t=>` <div class="transaction-card"><div class="transaction-header"><span class="transaction-amount">${parseInt(t["How much money? (Tsh)"]).toLocaleString()} Tsh</span><span class="confidence-badge">${t["Confidence level"]}</span></div><div class="transaction-details"><div class="transaction-field"><span class="field-label">Category</span><span class="field-value">${t["What's the Purchase Category"]}</span></div><div class="transaction-field"><span class="field-label">Paid To</span><span class="field-value">${t["Where was the money payed to?"]}</span></div><div class="transaction-field"><span class="field-label">Description</span><span class="field-value">${t["Purchase Description"]}</span></div></div><div class="transaction-actions"><button onclick="submitPendingTransaction('${t.id}')" class="action-button primary"><span class="button-icon">📤</span>Submit </button><button onclick="removePendingTransaction('${t.id}')" class="action-button danger"><span class="button-icon">🗑️</span>Remove </button></div></div>`).join('')} </div></div>`).join('')} </div><div class="modal-footer"><div class="total-amount">Total: ${pending.reduce((sum, t)=>sum + parseInt(t["How much money? (Tsh)"]), 0).toLocaleString()} Tsh </div><div class="modal-actions"><button onclick="submitAllPending()" class="action-button primary"><span class="button-icon">📤</span>Submit All </button><button onclick="closePendingTransactions()" class="action-button secondary">Close</button></div></div>`; document.body.appendChild(modal); const overlay=document.querySelector('.edit-overlay'); overlay.classList.add('show');} const styleSheet=document.createElement('style'); styleSheet.textContent=` .date-group{ margin-bottom: 16px;} .date-header{ width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-input); border: none; border-radius: 8px; color: var(--text-light); cursor: pointer; margin-bottom: 8px;} .date-header:hover{ background: var(--primary-color); color: var(--bg-dark);} .date-transactions{ display: none;} .date-transactions.show{ display: block;} .date-header .count{ color: var(--text-muted);} .date-header:hover .count{ color: var(--bg-dark);} .date-header .total{ font-weight: 500;} `; document.head.appendChild(styleSheet); window.toggleDateGroup=function (button){ const transactions=button.nextElementSibling; transactions.classList.toggle('show');}; window.removePendingTransaction=function (id){ if (confirm('Are you sure you want to remove this transaction?')){ OfflineStorage.removePendingTransaction(id); updatePendingBadge(); closePendingTransactions(); const remaining=OfflineStorage.getPendingTransactions(); if (remaining.length >0){ showPendingTransactions();} showSuccess('Transaction removed successfully');}}; const ModalManager={ currentField: null, currentValue: null, showEditModal(field, value){ try{ this.currentField=field; this.currentValue=value; const modal=document.querySelector('.edit-modal'); const content=modal.querySelector('.edit-modal-content'); if (!modal || !content){ console.error('Modal elements not found'); return;} let inputHtml=''; if (field==="What's the Purchase Category"){ inputHtml=` <select class="editable-select" style="width: 100%; padding: 8px;"><option value="Groceries & Household" ${value==="Groceries & Household" ? 'selected' : ''}>Groceries & Household</option><option value="Gift to Family & Friends" ${value==="Gift to Family & Friends" ? 'selected' : ''}>Gift to Family & Friends</option><option value="Petrol & Transport" ${value==="Petrol & Transport" ? 'selected' : ''}>Petrol & Transport</option><option value="Medical & Medicine" ${value==="Medical & Medicine" ? 'selected' : ''}>Medical & Medicine</option><option value="Utilities & Bills" ${value==="Utilities & Bills" ? 'selected' : ''}>Utilities & Bills</option><option value="Eating Out & Entertainment" ${value==="Eating Out & Entertainment" ? 'selected' : ''}>Eating Out & Entertainment</option><option value="(OTHER) Food, Transport, Groceries, etc." ${value==="(OTHER) Food, Transport, Groceries, etc." ? 'selected' : ''}>(OTHER) Food, Transport, Groceries, etc.</option></select>`;} else{ inputHtml=`<input type="text" class="editable-input" value="${(value || '').replace(/"/g, '"')}" style="width: 100%; padding: 8px;">`;} content.innerHTML=inputHtml; modal.classList.add('show'); const overlay=document.querySelector('.edit-overlay'); if (overlay){ overlay.classList.add('show');} const input=content.querySelector('input, select'); if (input){ input.focus(); if (input.tagName==='INPUT'){ input.setSelectionRange(0, input.value.length);}}} catch (error){ console.error('Failed to show edit modal:', error); showError('UI Error', 'Failed to open edit dialog');}}}; async function submitOnline(){ await submitTransaction(); closeTransactionReview();} function updatePendingBadge(){ const badge=document.querySelector('.pending-badge'); if (!badge) return; const pending=OfflineStorage.getPendingTransactions(); badge.textContent=pending.length; badge.style.display=pending.length >0 ? 'block' : 'none';} function clearForm(){ const inputText=document.getElementById('inputText'); if (inputText) inputText.value=''; window.transactions=[]; window.currentTransactionIndex=0; const editableContainer=document.getElementById('editableContainer'); if (editableContainer) editableContainer.innerHTML=''; const livePreview=document.querySelector('.live-preview'); if (livePreview) livePreview.classList.remove('show'); updateTransactionCounter();} function updateTransactionCounter(){ const indicator=document.querySelector('.transaction-indicator'); const prevBtn=document.getElementById('prevTransaction'); const nextBtn=document.getElementById('nextTransaction'); if (!indicator || !prevBtn || !nextBtn) return; if (window.transactions && window.transactions.length >0){ indicator.textContent=`${window.currentTransactionIndex + 1} of ${window.transactions.length}`; prevBtn.disabled=window.currentTransactionIndex===0; nextBtn.disabled=window.currentTransactionIndex===window.transactions.length - 1;} else{ indicator.textContent='No Transactions'; prevBtn.disabled=true; nextBtn.disabled=true;}} function navigateTransaction(direction){ const newIndex=window.currentTransactionIndex + direction; if (newIndex >=0 && newIndex < window.transactions.length){ window.currentTransactionIndex=newIndex; displayEditableFields(window.transactions[newIndex]); updateTransactionCounter();}} function editTransaction(index){ if (index >=0 && index < window.transactions.length){ window.currentTransactionIndex=index; displayEditableFields(window.transactions[index]); updateTransactionCounter(); closeTransactionReview();}} function removeTransaction(index){ if (confirm('Are you sure you want to remove this transaction?')){ window.transactions.splice(index, 1); if (window.currentTransactionIndex >=window.transactions.length){ window.currentTransactionIndex=Math.max(0, window.transactions.length - 1);} if (window.transactions.length >0){ displayEditableFields(window.transactions[window.currentTransactionIndex]);} else{ document.getElementById("editableContainer").innerHTML="";} updateTransactionCounter(); closeTransactionReview(); if (window.transactions.length >0){ showTransactionReview();}}} window.closeEditModal=function (){ document.querySelector('.edit-modal').classList.remove('show'); document.querySelector('.edit-overlay').classList.remove('show');}; window.closeTransactionReview=function (){ const modal=document.querySelector('.edit-modal.show'); if (modal) modal.remove(); document.querySelector('.edit-overlay').classList.remove('show');}; window.closePendingTransactions=function (){ const modal=document.querySelector('.edit-modal.show'); if (modal) modal.remove(); document.querySelector('.edit-overlay').classList.remove('show');}; window.saveEdit=function (){ const modal=document.querySelector('.edit-modal'); const input=modal.querySelector('.editable-input, .editable-select'); if (input && ModalManager.currentField && window.transactions[window.currentTransactionIndex]){ window.transactions[window.currentTransactionIndex][ModalManager.currentField]=input.value; displayEditableFields(window.transactions[window.currentTransactionIndex]);} closeEditModal();}; async function submitPendingTransaction(id){ try{ showLoading(); const pending=OfflineStorage.getPendingTransactions(); const transaction=pending.find(t=>t.id===id); if (!transaction){ throw new Error('Transaction not found');} window.transactions=[transaction]; window.currentTransactionIndex=0; await submitTransaction(); OfflineStorage.removePendingTransaction(id); const remaining=OfflineStorage.getPendingTransactions(); closePendingTransactions(); if (remaining.length >0){ showPendingTransactions();}} catch (error){ console.error('Submit pending transaction error:', error); showError('Submit Error', 'Failed to submit transaction. Please try again.');} finally{ hideLoading();}} async function submitAllPending(){ try{ showLoading(); const pending=OfflineStorage.getPendingTransactions(); let successCount=0; for (const transaction of pending){ try{ window.transactions=[transaction]; window.currentTransactionIndex=0; await submitTransaction(); OfflineStorage.removePendingTransaction(transaction.id); successCount++;} catch (error){ console.error('Failed to submit transaction:', error);}} closePendingTransactions(); if (successCount >0){ showSuccess(`Successfully submitted ${successCount} transaction${successCount >1 ? 's' : ''}`);} const remaining=OfflineStorage.getPendingTransactions(); if (remaining.length >0){ showPendingTransactions();}} catch (error){ console.error('Submit all pending error:', error); showError('Submit Error', 'Failed to submit all transactions. Some may need to be retried.');} finally{ hideLoading();}} function toggleCollapsible(event){ if (event.target.closest('.feedback-buttons')){ return;} const section=document.querySelector('.collapsible-section'); section.classList.toggle('collapsed');} </script><style>:root{ --primary-color: #f5a623; --bg-dark: #1e1e2e; --bg-card: #28293d; --bg-input: #33344b; --text-light: #f5f5f5; --text-muted: #8e8ea0; --spacing-unit: clamp(8px, 2vw, 20px);} body{ font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-dark); color: var(--text-light); margin: 0; padding: 0; min-height: 100vh; display: flex; flex-direction: column;} .container{ display: flex; flex-direction: column; height: 100vh; width: min(600px, 95%); margin: 0 auto; padding: 16px; gap: 16px; background: var(--bg-card); position: relative; overflow: hidden; border-radius: 12px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);} h1{ font-size: 1.5rem; margin: 0; padding: 8px 0; text-align: center; flex-shrink: 0;} .version{ font-size: 0.7em; opacity: 0.7;} .results-section{ flex: 1; overflow-y: auto; padding: 16px; margin-bottom: 16px; background: var(--bg-card); border-radius: 8px; order: 1;} .live-preview{ background: var(--bg-input); border-radius: 8px; padding: 12px; margin-bottom: 12px; font-size: 14px; color: var(--text-light); display: none;} .live-preview.show{ display: block;} .input-section{ position: sticky; bottom: 0; background: var(--bg-card); padding: 16px; border-top: 1px solid var(--bg-input); margin: 0 -16px -16px; order: 2; z-index: 100;} .transaction-navigation{ display: flex; align-items: center; justify-content: center; gap: 8px; padding: 8px 0; flex-shrink: 0;} .nav-button{ background: var(--bg-input); border: none; color: var(--text-light); width: 32px; height: 32px; border-radius: 16px; cursor: pointer; opacity: 0.8;} .nav-button:not(:disabled):hover{ opacity: 1; transform: translateY(-1px);} .nav-button:disabled{ opacity: 0.3; cursor: not-allowed;} .transaction-indicator{ min-width: 80px; text-align: center; font-size: 0.9em; color: var(--text-muted);} .editable-container{ flex: 1; overflow-y: auto; display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; padding: 12px; background: var(--bg-input); border-radius: 8px; margin-bottom: 8px;} .editable-field{ background: var(--bg-card); padding: 12px; border-radius: 6px; cursor: pointer; transition: transform 0.2s ease, background-color 0.2s ease; display: flex; flex-direction: column; gap: 4px;} .editable-field:hover{ transform: translateY(-1px); background: var(--bg-input);} .editable-field.full-width{ grid-column: 1 / -1;} .editable-label{ font-size: 11px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;} .editable-value{ font-size: 14px; line-height: 1.4; word-break: break-word; color: var(--text-light);} .input-wrapper{ position: relative;} .input-wrapper input[type="text"]{ width: 100%; padding: 12px; background: var(--bg-input); color: var(--text-light); border: none; border-radius: 8px; font-size: 16px; line-height: 1.4; margin-bottom: 8px; height: 48px; font-family: inherit; transition: all 0.2s ease;} .input-wrapper input[type="text"]:focus{ outline: 1px solid var(--primary-color); box-shadow: 0 0 0 2px rgba(245, 166, 35, 0.2); transform: translateY(-1px);} .input-wrapper input[type="text"]::placeholder{ color: var(--text-muted);} .action-buttons{ display: flex; gap: 8px;} .primary-button, .secondary-button{ flex: 1; height: 40px; padding: 0 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: transform 0.2s, background-color 0.2s;} .primary-button{ background: var(--primary-color); color: var(--bg-dark);} .secondary-button{ background: var(--bg-input); color: var(--text-light); position: relative;} .button-icon{ font-size: 1.1em;} .pending-badge{ position: absolute; top: -6px; right: -6px; background: var(--primary-color); color: var(--bg-dark); border-radius: 10px; padding: 2px 6px; font-size: 11px; font-weight: bold;} @media screen and (max-width: 768px){ .container{ width: 90%; min-width: 90%; height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom)); padding: 12px; border-radius: 0; box-shadow: none;} .input-section{ padding: 12px; padding-bottom: max(12px, env(safe-area-inset-bottom));} .action-buttons{ grid-template-columns: repeat(3, 1fr); gap: 6px;} .action-button{ padding: 8px; font-size: 13px;} .button-icon{ font-size: 16px;} .nav-button, .action-button, .date-header{ min-height: 44px;} .transaction-card{ padding: 12px; margin-bottom: 8px;} .field-label{ font-size: 11px;} .field-value{ font-size: 13px;} .results-section{ -webkit-overflow-scrolling: touch; scroll-padding: 20px;}} .transaction-review-modal{ max-width: min(800px, 95vw); max-height: 90vh; display: flex; flex-direction: column;} .transaction-list{ flex: 1; overflow-y: auto; padding: 8px 0; margin: 12px 0;} .transaction-item{ background: var(--bg-input); border-radius: 8px; padding: 12px; margin-bottom: 8px;} .transaction-item.current{ border: 2px solid var(--primary-color);} .transaction-actions{ display: flex; gap: 8px; margin-top: 8px;} .modal-footer{ border-top: 1px solid var(--bg-input); padding-top: 12px; margin-top: 12px; display: flex; justify-content: space-between; align-items: center;} .total-amount{ font-size: 1.1em; color: var(--primary-color); font-weight: 500;} .edit-overlay{ position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); z-index: 1002; display: none; opacity: 0; transition: opacity 0.3s ease;} .edit-overlay.show{ display: flex; justify-content: center; align-items: center; opacity: 1;} .edit-modal{ background: var(--bg-card); border-radius: 12px; padding: 20px; width: 90%; max-width: 400px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4); transform: translateY(-20px); opacity: 0; transition: transform 0.3s ease, opacity 0.3s ease; display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1003;} .edit-modal.show{ display: block; transform: translate(-50%, -50%); opacity: 1;} .edit-modal h3{ margin: 0 0 15px 0; color: var(--text-light);} .edit-modal-content{ margin-bottom: 20px;} .edit-modal-content input, .edit-modal-content select{ width: 100%; padding: 10px; border: 1px solid var(--bg-input); border-radius: 6px; background: var(--bg-input); color: var(--text-light); font-size: 16px;} .edit-modal-buttons{ display: flex; gap: 10px;} .edit-modal-buttons button{ flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background-color 0.2s;} .edit-modal-buttons button:not(.cancel){ background: var(--primary-color); color: var(--bg-dark);} .edit-modal-buttons button.cancel{ background: var(--bg-input); color: var(--text-light);} .compact-field{ cursor: pointer; position: relative;} .compact-field:hover::after{ content: '✎'; position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: #f5a623; font-size: 14px;} .compact-field.edited::before{ content: ''; position: absolute; left: -15px; top: 50%; transform: translateY(-50%); color: #4CAF50; font-size: 12px;} .edited-indicator{ position: absolute; right: -25px; top: 50%; transform: translateY(-50%); color: #4CAF50; font-size: 12px; font-weight: bold; opacity: 0; transition: opacity 0.3s;} .edited .edited-indicator{ opacity: 1;} .compact-field{ position: relative; padding: 8px; border-radius: 6px; transition: background-color 0.2s;} .compact-field:hover{ background-color: #3f4060;} .compact-field.edited{ padding-left: 25px;} .compact-field.edited::before{ left: 5px;} @media screen and (max-width: 768px){ .edit-modal{ width: 95%; max-width: none; margin: 10px;} .edit-modal .editable-input, .edit-modal .editable-select{ font-size: 16px; padding: 12px;} .edit-modal-buttons button{ padding: 12px; font-size: 16px;}} @media (hover: none){ .transaction-navigation::after{ content: 'Swipe to navigate'; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #8e8ea0; opacity: 0.7;}} .title-section{ position: sticky; top: 0; background: var(--bg-card); padding: var(--spacing-unit) 0; margin: calc(var(--spacing-unit) * -1) calc(var(--spacing-unit) * -1 0); border-bottom: 1px solid rgba(255, 255, 255, 0.1); z-index: 10;} .collapsible-trigger{ background: none; border: none; color: var(--primary-color); cursor: pointer; padding: 8px; width: 100%; text-align: left; font-size: 14px; display: flex; align-items: center; gap: 8px; margin-top: 8px;} .collapsible-trigger::before{ content: '+'; font-size: 18px; font-weight: bold;} .collapsible-trigger.expanded::before{ content: '-';} .collapsible-content{ display: none; padding-top: 8px;} .collapsible-content.show{ display: block;} .confidence-display{ color: var(--text-muted); font-size: 12px; text-align: right; padding: 4px 8px; background: var(--bg-input); border-radius: 4px; margin-top: 4px;} .feedback-section{ display: flex; align-items: center; gap: 10px; padding: 10px; background: var(--bg-input); border-radius: 8px; margin-bottom: 12px;} .feedback-button{ background: none; border: none; font-size: 20px; cursor: pointer; opacity: 0.7; transition: opacity 0.2s;} .feedback-button:hover{ opacity: 1;} .feedback-options{ display: flex; flex-direction: column; gap: 10px; margin: 15px 0;} .feedback-options label{ display: flex; align-items: center; gap: 8px; color: var(--text-light);} .correction-fields{ margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--bg-input);} .submit-options{ display: flex; flex-direction: column; gap: 12px; margin: 15px 0;} .submit-option{ display: flex; flex-direction: column; align-items: flex-start; padding: 12px; background: var(--bg-input); border: none; border-radius: 8px; color: var(--text-light); cursor: pointer; transition: background 0.2s, transform 0.2s; width: 100%; text-align: left;} .submit-option:hover{ background: var(--primary-color); color: var(--bg-dark); transform: translateY(-1px);} .submit-option small{ color: var(--text-muted); font-size: 0.8em; margin-top: 4px;} .submit-option:hover small{ color: var(--bg-dark);} .pending-transactions{ margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--bg-input);} .pending-transactions h4{ color: var(--text-muted); font-size: 0.9em; margin: 0 0 8px 0;} .view-pending{ width: 100%; padding: 10px; background: var(--bg-input); border: none; border-radius: 8px; color: var(--text-light); cursor: pointer; transition: background 0.2s;} .view-pending:hover{ background: var(--primary-color); color: var(--bg-dark);} .pending-list{ display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; max-height: 60vh; overflow-y: auto; padding: 4px; margin: 15px 0;} .pending-item{ background: var(--bg-input); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; gap: 8px;} .pending-info{ margin-bottom: 8px;} .pending-details{ display: flex; flex-wrap: wrap; gap: 8px; margin-top: 4px; font-size: 0.9em; color: var(--text-muted);} .pending-actions{ display: flex; gap: 8px;} .pending-actions button{ padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; transition: transform 0.2s, opacity 0.2s;} .pending-actions button:hover{ transform: translateY(-1px); opacity: 0.9;} .submit-one{ background: var(--primary-color); color: var(--bg-dark);} .remove-one{ background: var(--bg-card); color: var(--text-light);} .submit-all{ background: var(--primary-color); color: var(--bg-dark); padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; transition: transform 0.2s, opacity 0.2s;} .submit-all:hover{ transform: translateY(-1px); opacity: 0.9;} @media screen and (max-width: 768px){ .pending-list{ max-height: 70vh;} .pending-actions{ flex-direction: column;} .pending-actions button{ width: 100%; padding: 8px;}} .input-wrapper textarea{ width: 100%; padding: 12px; background: var(--bg-input); color: var(--text-light); border: none; border-radius: 8px; resize: vertical; min-height: 60px; font-family: inherit; font-size: 14px; line-height: 1.4;} .input-wrapper textarea:focus{ outline: 1px solid var(--primary-color); box-shadow: 0 0 0 2px rgba(245, 166, 35, 0.2);} .input-wrapper textarea::placeholder{ color: var(--text-muted);} .view-saved-button{ background: var(--bg-input); color: var(--text-light); height: 40px; padding: 0 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: transform 0.2s, background-color 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 4px; position: relative;} .view-saved-button:hover{ background: #444561; transform: translateY(-1px);} @media screen and (max-width: 768px){ .action-buttons{ grid-template-columns: 1fr 1fr 1fr;} .view-saved-button{ width: 100%; justify-content: center;}} .container{ display: flex; flex-direction: column; height: 100vh; max-width: 600px; margin: 0 auto; padding: 16px; gap: 16px; background: var(--bg-card);} .input-section{ order: -1; position: relative; padding: 16px; background: var(--bg-card); border-bottom: 1px solid var(--bg-input);} .results-section{ flex: 1; overflow-y: auto; padding: 8px 0;} .transaction-review{ display: flex; flex-direction: column; gap: 12px; max-height: calc(100vh - 200px); overflow-y: auto;} .transaction-card{ background: var(--bg-input); border-radius: 8px; padding: 16px; display: grid; gap: 12px;} .transaction-header{ display: flex; justify-content: space-between; align-items: center;} .transaction-amount{ font-size: 1.2em; font-weight: 500; color: var(--primary-color);} .transaction-details{ display: grid; gap: 8px;} .transaction-field{ display: flex; flex-direction: column; gap: 4px;} .field-label{ font-size: 0.8em; color: var(--text-muted);} .field-value{ font-size: 0.95em;} .transaction-actions{ display: flex; gap: 8px; margin-top: 8px;} .action-button{ flex: 1; padding: 8px 12px; border: none; border-radius: 6px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 4px; transition: transform 0.2s;} .action-button:hover{ transform: translateY(-1px);} .action-button.primary{ background: var(--primary-color); color: var(--bg-dark);} .action-button.secondary{ background: var(--bg-card); color: var(--text-light);} .action-button.danger{ background: #ff4444; color: white;} @media screen and (max-width: 768px){ .container{ padding: 12px; height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));} .input-section{ padding: 12px;} .transaction-actions{ flex-direction: column;} .action-button{ width: 100%;}} .container{ display: flex; flex-direction: column; height: 100vh; max-width: 600px; margin: 0 auto; padding: 16px; gap: 16px; background: var(--bg-card);} .results-section{ flex: 1; overflow-y: auto; padding: 0; margin-bottom: 16px; order: 1; } .input-section{ position: sticky; bottom: 0; background: var(--bg-card); padding: 16px; border-top: 1px solid var(--bg-input); margin: 0 -16px -16px; order: 2; z-index: 100;} .live-preview{ background: var(--bg-input); border-radius: 8px; padding: 12px; margin-bottom: 12px; font-size: 14px; color: var(--text-light); display: none;} .live-preview.show{ display: block;} .action-buttons{ display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 12px;} .edit-overlay{ z-index: 1000;} .edit-modal{ z-index: 1001;} .loading-overlay{ z-index: 1002;} .error-notification{ z-index: 1003;} .date-group{ margin-bottom: 16px;} .date-header{ width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-input); border: none; border-radius: 8px; color: var(--text-light); cursor: pointer; margin-bottom: 8px;} .date-header:hover{ background: var(--primary-color); color: var(--bg-dark);} .date-transactions{ display: none;} .date-transactions.show{ display: block;} .date-header .count{ color: var(--text-muted);} .date-header:hover .count{ color: var(--bg-dark);} .date-header .total{ font-weight: 500;} .loading-overlay{ position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 1002;} .loading-spinner{ width: 50px; height: 50px; border: 3px solid var(--text-muted); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite;} .success-notification{ position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 12px 24px; border-radius: 8px; font-size: 14px; z-index: 1004; opacity: 0; transition: opacity 0.3s; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);} .success-notification.show{ opacity: 1;} .error-notification{ position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ff4444; color: white; padding: 16px; border-radius: 8px; max-width: 90%; width: 400px; display: none; z-index: 1003; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);} .error-notification.show{ display: block; animation: slideIn 0.3s ease-out;} @keyframes slideIn{ from{ transform: translate(-50%, -100%); opacity: 0;} to{ transform: translate(-50%, 0); opacity: 1;}} @keyframes spin{ to{ transform: rotate(360deg);}} .input-wrapper{ position: relative; margin-bottom: 8px;} .input-wrapper input[type="text"]{ width: 100%; padding: 12px; background: var(--bg-input); color: var(--text-light); border: none; border-radius: 8px; font-size: 16px; line-height: 1.4; margin-bottom: 8px; height: 48px; font-family: inherit; transition: all 0.2s ease;} .input-wrapper input[type="text"]:focus{ outline: 1px solid var(--primary-color); box-shadow: 0 0 0 2px rgba(245, 166, 35, 0.2); transform: translateY(-1px);} .input-wrapper input[type="text"]::placeholder{ color: var(--text-muted);} .input-wrapper .character-count{ position: absolute; right: 8px; bottom: 8px; font-size: 12px; color: var(--text-muted); pointer-events: none;} .action-buttons{ display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px;} .action-button{ position: relative; padding: 10px 16px; border: none; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: transform 0.2s, background-color 0.2s; overflow: hidden;} .action-button::after{ content: ''; position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.1); transform: translate(-50%, -50%) scale(0); border-radius: 50%; transition: transform 0.3s;} .action-button:active::after{ transform: translate(-50%, -50%) scale(2);} .primary-button{ background: var(--primary-color); color: var(--bg-dark);} .secondary-button{ background: var(--bg-input); color: var(--text-light);} .transaction-card{ background: var(--bg-input); border-radius: 8px; padding: 16px; margin-bottom: 12px; transition: transform 0.2s;} .transaction-card:hover{ transform: translateY(-2px);} .transaction-header{ display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;} .transaction-amount{ font-size: 1.2em; font-weight: 500; color: var(--primary-color);} .confidence-badge{ padding: 4px 8px; border-radius: 12px; font-size: 12px; background: var(--bg-card); color: var(--text-muted);} .transaction-details{ display: grid; gap: 8px; margin-bottom: 12px;} .transaction-field{ display: flex; flex-direction: column; gap: 2px;} .field-label{ font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;} .field-value{ font-size: 14px; color: var(--text-light);} @media screen and (max-width: 768px){ .container{ padding: 12px; height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));} .input-section{ padding: 12px; padding-bottom: max(12px, env(safe-area-inset-bottom));} .action-buttons{ grid-template-columns: 1fr;} .transaction-card{ padding: 12px;} .transaction-actions{ flex-direction: column; gap: 8px;} .action-button{ width: 100%;}} .input-wrapper input[type="text"]:focus+.character-count{ color: var(--primary-color);} *:focus-visible{ outline: 2px solid var(--primary-color); outline-offset: 2px;} .action-button.loading{ opacity: 0.7; cursor: not-allowed;} .action-button.loading .button-icon{ animation: spin 1s linear infinite;} .empty-state{ display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px 16px; text-align: center; color: var(--text-muted);} .empty-state-icon{ font-size: 48px; margin-bottom: 16px; opacity: 0.5;} .empty-state-text{ font-size: 14px; line-height: 1.5; max-width: 280px; margin: 0 auto;} .input-wrapper input[type="text"]{ transition: all 0.2s ease;} .input-wrapper input[type="text"]:focus{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);} .processing{ position: relative; pointer-events: none;} .processing::after{ content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); border-radius: inherit; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--text-light);} .confidence-indicator{ display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 12px; font-size: 12px; background: var(--bg-card);} .confidence-high{ color: #4CAF50;} .confidence-medium{ color: #FFC107;} .confidence-low{ color: #FF5722;} .help-text{ font-size: 12px; color: var(--text-muted); margin-top: 4px; padding: 0 4px;} .keyboard-shortcuts{ position: absolute; bottom: 8px; right: 8px; font-size: 11px; color: var(--text-muted); pointer-events: none;} .keyboard-shortcut{ display: inline-flex; align-items: center; gap: 4px; margin-left: 8px;} .key{ padding: 2px 4px; border-radius: 4px; background: var(--bg-input); font-family: monospace;} @media screen and (max-width: 768px){ body{ position: relative; height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch;} .container{ width: 90%; min-width: 90%; height: auto; min-height: 100vh; padding: 12px; display: flex; flex-direction: column; border-radius: 0; box-shadow: none;} .input-section{ position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-card); padding: 12px; padding-bottom: max(12px, env(safe-area-inset-bottom)); border-top: 1px solid var(--bg-input); z-index: 100; transform: translateZ(0);} .input-wrapper{ position: relative; margin-bottom: 8px;} .input-wrapper input[type="text"]{ max-height: 80px; padding: 10px; font-size: 16px; line-height: 1.3; border-radius: 8px;} .results-section{ margin-bottom: 160px; padding-bottom: env(safe-area-inset-bottom); overflow-y: visible;} .container.keyboard-visible{ padding-bottom: 160px;} .input-section.keyboard-visible{ position: sticky;} .action-buttons{ display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;} .action-button{ height: 44px; padding: 0 12px; font-size: 13px;} .button-icon{ font-size: 18px;} .results-section{ -webkit-overflow-scrolling: touch; scroll-padding-bottom: 160px;} .live-preview{ margin: 8px 0; padding: 10px; border-radius: 6px;} .transaction-card{ margin-bottom: 10px; padding: 12px;}} @supports (-webkit-touch-callout: none){ .input-section{ padding-bottom: max(12px, env(safe-area-inset-bottom));} .results-section{ padding-bottom: env(safe-area-inset-bottom);}} .info-notification, .warning-notification{ position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 16px; border-radius: 8px; max-width: 90%; width: 400px; z-index: 1003; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); animation: slideIn 0.3s ease-out;} .info-notification{ background: var(--bg-input); color: var(--text-light); border-left: 4px solid var(--primary-color);} .warning-notification{ background: #FFA726; color: var(--bg-dark);} .info-title, .warning-title{ font-weight: 500; margin-bottom: 8px;} .info-message, .warning-message{ font-size: 14px; line-height: 1.4;} .mode-indicator{ position: fixed; bottom: 20px; right: 20px; padding: 8px 12px; border-radius: 20px; font-size: 12px; background: var(--bg-input); color: var(--text-muted); z-index: 1000; display: flex; align-items: center; gap: 6px;} .mode-indicator::before{ content: ''; width: 8px; height: 8px; border-radius: 50%; background: #FFA726;} .mode-indicator.online::before{ background: #4CAF50;} @media screen and (max-width: 768px){ .mode-indicator{ bottom: 80px;}} .collapsible-section{ margin-bottom: 12px;} .collapsible-header{ cursor: pointer; transition: background-color 0.2s;} .collapsible-header:hover{ background: var(--bg-card);} .collapsible-header::after{ content: '▼'; float: right; transition: transform 0.3s ease; font-size: 12px; color: var(--text-muted);} .collapsible-section.collapsed .collapsible-header::after{ transform: rotate(-90deg);} .collapsible-content{ max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease-out;} .collapsible-section.collapsed .collapsible-content{ max-height: 0;} .live-preview{ background: var(--bg-input); border-radius: 8px 8px 0 0; padding: 12px; font-size: 14px; color: var(--text-light); display: none;} .live-preview.show{ display: block;} .collapsible-section.collapsed .live-preview{ border-radius: 8px;} .preview-content{ display: flex; flex-direction: column; gap: 12px;} .preview-main{ display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;} .amount-display{ font-size: 1.4em; font-weight: 500; color: var(--primary-color);} .preview-details{ display: flex; flex-direction: column; gap: 8px; flex: 1;} .category-tag, .paid-to-tag{ display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background: var(--bg-card); border-radius: 6px; font-size: 0.9em; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;} .tag-icon{ font-size: 0.9em; opacity: 0.8;} .preview-footer{ display: flex; justify-content: space-between; align-items: center; padding-top: 8px; border-top: 1px solid var(--bg-card);} .confidence-indicator{ display: flex; align-items: center; gap: 6px; font-size: 0.85em; color: var(--text-muted);} .confidence-dot{ width: 8px; height: 8px; border-radius: 50%; background: currentColor;} .confidence-high{ color: #4CAF50;} .confidence-medium{ color: #FFC107;} .confidence-low{ color: #FF5722;} .feedback-buttons{ display: flex; gap: 8px;} .feedback-button{ background: var(--bg-card); border: none; color: var(--text-light); width: 28px; height: 28px; border-radius: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s, background-color 0.2s;} .feedback-button:hover{ transform: translateY(-1px);} .feedback-button.positive:hover{ background: #4CAF50;} .feedback-button.negative:hover{ background: #FF5722;} @media screen and (max-width: 480px){ .preview-main{ flex-direction: column; gap: 12px;} .preview-details{ width: 100%;} .category-tag, .paid-to-tag{ width: 100%;}} .collapsible-header::after{ position: absolute; right: 12px; top: 50%; transform: translateY(-50%); transition: transform 0.3s ease;} .collapsible-section.collapsed .collapsible-header::after{ transform: translateY(-50%) rotate(-90deg);} .live-preview{ position: relative; padding: 16px;} </style></head><body><div class="loading-overlay"><div class="loading-spinner"></div></div><div class="error-notification"><div class="error-content"><div class="error-title"></div><div class="error-message"></div></div><button class="error-close" onclick="closeError()">×</button></div><div class="container"><h1>ExpenSphere <span class="version">v0.0.29</span></h1><div class="results-section"><div class="collapsible-section"><div class="live-preview collapsible-header"></div><div id="editableContainer" class="editable-container collapsible-content"></div></div><div class="transaction-navigation"><button class="nav-button" id="prevTransaction" disabled onclick="navigateTransaction(-1)">←</button><span class="transaction-indicator">No Transactions</span><button class="nav-button" id="nextTransaction" disabled onclick="navigateTransaction(1)">→</button></div></div><div class="input-section"><div class="input-wrapper"><input type="text" id="inputText" autofocus placeholder="Type expense (e.g., 'gave irene 50k for home')" style="width: 100%; padding: 12px; background: var(--bg-input); color: var(--text-light); border: none; border-radius: 8px; font-size: 16px; line-height: 1.4; margin-bottom: 8px; height: 48px;"></div><div class="action-buttons"><button class="primary-button" onclick="submitTransaction()"><span class="button-icon">📝</span>Submit </button><button class="secondary-button" onclick="saveForLater()"><span class="button-icon">💾</span>Save </button><button class="secondary-button" onclick="showPendingTransactions()"><span class="button-icon">📋</span>Saved <span class="pending-badge" style="display: none;">0</span></button></div></div></div><div class="edit-overlay"></div><div class="edit-modal"><h3>Edit Field</h3><div class="edit-modal-content"></div><div class="edit-modal-buttons"><button class="cancel" onclick="window.closeEditModal()">Cancel</button><button onclick="window.saveEdit()">Save</button></div></div><script src="https://accounts.google.com/gsi/client"></script><script src="https://apis.google.com/js/api.js"></script></body></html>