<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e2e;
            color: #f5f5f5;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            align-self: flex-start;
            width: 90%;
            max-width: 600px;
            background-color: #28293d;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            margin-top: 0;
            color: #f5a623;
        }
        textarea {
            width: 100%;
            height: 120px;
            background-color: #33344b;
            color: #f5f5f5;
            border: none;
            padding: 5px;
            border-radius: 8px;
            font-size: 16px;
            resize: none;
        }
        textarea:focus {
            outline: none;
            border: 2px solid #f5a623;
        }
        button {
            width: 100%;
            padding: 15px;
            background-color: #f5a623;
            color: #1e1e2f;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background-color: #d48821;
        }
        .editable-container {
            margin: 20px 0;
        }
        .editable-field {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        .editable-label {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .editable-input, .editable-select {
            padding: 10px;
            border-radius: 8px;
            border: none;
            background-color: #33344b;
            color: #f5f5f5;
            font-size: 14px;
        }
        .editable-input:focus, .editable-select:focus {
            outline: 2px solid #f5a623;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Expense Tracker</h1>
        <textarea id="inputText" placeholder="Type your expense description and press Enter..."></textarea>
        <button onclick="authorize()">Submit</button>
        <div class="editable-container" id="editableContainer"></div>
        <div class="confidence" id="confidence">Confidence Score: 0%</div>
    </div>

    <script>
        const CLIENT_ID = "35324134118-oit317sdim38b1h0pbmje25j8dfs10jo.apps.googleusercontent.com";
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
        const SPREADSHEET_ID = "1dagJ19LGKdGy1o_uD2Ggsyi2kt8PhTyVXfufO4A55eA";

        const trainingData = [
            { category: "Petrol & Transport", keywords: ["petrol", "raum", "bmw", "fuel"] },
            { category: "Car Maintenance & Fee's", keywords: ["repair", "maintenance", "oil", "service"] },
            { category: "Groceries", keywords: ["milk", "groceries", "maid", "shopping"] },
            { category: "Gift to Family & Friends", keywords: ["gift", "donation", "contribution", "help", "irene"] },
            { category: "Utilities", keywords: ["luku", "electricity", "water", "gas", "trash"] },
            { category: "Eating Out", keywords: ["food", "restaurant", "chips", "lunch"] },
            { category: "Medical & Medicine", keywords: ["hospital", "medicine", "doctor"] },
            { category: "Aaliyah Investment", keywords: ["aaliyah", "school", "karate", "hair"] },
            { category: "Celebration", keywords: ["anniversary", "party", "event"] },
            { category: "(OTHER)", keywords: ["miscellaneous", "unknown"] }
        ];

        let tokenClient;
        let generatedData = {};

        document.getElementById("inputText").addEventListener("input", processInput);
        document.getElementById("inputText").addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                authorize();
            }
        });

        function processInput() {
            const input = document.getElementById("inputText").value.toLowerCase();
            const amountMatch = input.match(/(\d{1,3}(?:,\d{3})*|[0-9]+)\s?k/i);
            const amount = amountMatch ? parseInt(amountMatch[1].replace(/,/g, '')) * (amountMatch[0].includes('k') ? 1000 : 1) : null;

            let category = "(OTHER)";
            let matchedKeywords = [];
            let totalKeywords = 0;

            for (const { category: cat, keywords } of trainingData) {
                const matches = keywords.filter(keyword => input.includes(keyword));
                if (matches.length > 0 && matches.length > matchedKeywords.length) {
                    category = cat;
                    matchedKeywords = matches;
                    totalKeywords = keywords.length;
                }
            }

            const score = matchedKeywords.length > 0 ? Math.round((matchedKeywords.length / totalKeywords) * 100) : 0;

            generatedData = {
                "Date of Transaction": new Date().toISOString().split("T")[0],
                "Where did the money come from?": "ALBERT",
                "How much money? (Tsh)": amount || "Unknown",
                "What's the Purchase Category": category,
                "Purchase Description": input,
                "Where was the money payed to?": "",
                "Confidance level": `${score}%`
            };

            displayEditableFields(generatedData);
            document.getElementById("confidence").textContent = `Confidence Score: ${score}%`;
        }

        function displayEditableFields(data) {
            const container = document.getElementById("editableContainer");
            container.innerHTML = "";

            const dateField = document.createElement("div");
            dateField.className = "editable-field";
            dateField.innerHTML = `
                <label class="editable-label">Date of Transaction</label>
                <input type="date" class="editable-input" value="${data["Date of Transaction"]}" onchange="updateField('Date of Transaction', this.value)">
            `;
            container.appendChild(dateField);

            const categoryField = document.createElement("div");
            categoryField.className = "editable-field";
            const options = trainingData.map(entry => `<option value="${entry.category}" ${entry.category === data["What's the Purchase Category"] ? "selected" : ""}>${entry.category}</option>`).join("");
            categoryField.innerHTML = `
                <label class="editable-label">What's the Purchase Category</label>
                <select class="editable-select" onchange="updateField('What\'s the Purchase Category', this.value)">
                    ${options}
                </select>
            `;
            container.appendChild(categoryField);

            const descriptionField = document.createElement("div");
            descriptionField.className = "editable-field";
            descriptionField.innerHTML = `
                <label class="editable-label">Purchase Description</label>
                <textarea class="editable-input" onchange="updateField('Purchase Description', this.value)" rows="3">${data["Purchase Description"]}</textarea>
            `;
            container.appendChild(descriptionField);

            const amountField = document.createElement("div");
            amountField.className = "editable-field";
            amountField.innerHTML = `
                <label class="editable-label">How much money? (Tsh)</label>
                <input type="number" class="editable-input" value="${data["How much money? (Tsh)"]}" onchange="updateField('How much money? (Tsh)', this.value)">
            `;
            container.appendChild(amountField);

            const paidToField = document.createElement("div");
            paidToField.className = "editable-field";
            paidToField.innerHTML = `
                <label class="editable-label">Where was the money payed to?</label>
                <input type="text" class="editable-input" value="${data["Where was the money payed to?"]}" onchange="updateField('Where was the money payed to?', this.value)">
            `;
            container.appendChild(paidToField);

            const confidenceField = document.createElement("div");
            confidenceField.className = "editable-field";
            confidenceField.innerHTML = `
                <label class="editable-label">Confidance level</label>
                <input type="text" class="editable-input" value="${data["Confidance level"]}" readonly>
            `;
            container.appendChild(confidenceField);
        }

        function updateField(field, value) {
            generatedData[field] = value;
        }

        // Function to check if stored token is still valid
        function isTokenValid(token) {
            if (!token) return false;
            
            return fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/ExpenseResults!A1`,
                {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                }
            )
            .then(response => response.ok)
            .catch(() => false);
        }

        // Function to handle the token storage
        function storeToken(token) {
            localStorage.setItem('expenseTrackerToken', token);
            localStorage.setItem('tokenTimestamp', new Date().getTime());
        }

        // Function to get stored token
        function getStoredToken() {
            return localStorage.getItem('expenseTrackerToken');
        }

        // Function to clear stored token
        function clearStoredToken() {
            localStorage.removeItem('expenseTrackerToken');
            localStorage.removeItem('tokenTimestamp');
        }

        // Modified authorize function
        async function authorize() {
            const storedToken = getStoredToken();
            
            if (storedToken) {
                // Check if stored token is still valid
                const isValid = await isTokenValid(storedToken);
                if (isValid) {
                    submitData(storedToken);
                    return;
                } else {
                    clearStoredToken();
                }
            }

            // If no valid token, request new one
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: handleAuthResponse
            });
            tokenClient.requestAccessToken();
        }

        function handleAuthResponse(response) {
            if (response.error) {
                console.error("OAuth Error:", response);
                alert(`Authorization failed: ${response.error}. Please try again.`);
                clearStoredToken();
                return;
            }
            
            // Store the new token
            storeToken(response.access_token);
            submitData(response.access_token);
        }

        function submitData(token) {
            const values = [
                [
                    generatedData["Date of Transaction"],
                    generatedData["Where did the money come from?"],
                    generatedData["How much money? (Tsh)"],
                    generatedData["What's the Purchase Category"],
                    generatedData["Purchase Description"],
                    generatedData["Where was the money payed to?"],
                    generatedData["Confidance level"]
                ]
            ];

            // First, get the last row with data
            fetch(
                `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/ExpenseResults!A:G`,
                {
                    headers: {
                        Authorization: `Bearer ${token}`,
                    },
                }
            )
            .then(async (response) => {
                if (!response.ok) {
                    if (response.status === 401) {
                        clearStoredToken(); // Clear invalid token
                        throw new Error("Token expired. Please try again.");
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                return response.json();
            })
            .then((data) => {
                const lastRow = data.values ? data.values.length + 1 : 1;
                const range = `ExpenseResults!A${lastRow}`;

                return fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?valueInputOption=USER_ENTERED`,
                    {
                        method: "PUT",
                        headers: {
                            Authorization: `Bearer ${token}`,
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            range: range,
                            values: values,
                        }),
                    }
                );
            })
            .then(async (response) => {
                if (!response.ok) {
                    if (response.status === 401) {
                        clearStoredToken(); // Clear invalid token
                        throw new Error("Token expired. Please try again.");
                    }
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                return response.json();
            })
            .then(() => {
                alert("Data submitted successfully!");
                document.getElementById("inputText").value = "";
                document.getElementById("editableContainer").innerHTML = "";
                document.getElementById("confidence").textContent = "Confidence Score: 0%";
            })
            .catch((error) => {
                console.error("Detailed error:", error);
                let errorMessage = "Failed to submit data. ";
                
                if (error.message.includes("401") || error.message.includes("Token expired")) {
                    errorMessage += "Authentication expired. Please try submitting again.";
                    clearStoredToken();
                } else if (error.message.includes("403")) {
                    errorMessage += "You don't have permission to access this spreadsheet. Please check your access rights.";
                } else if (error.message.includes("404")) {
                    errorMessage += "Spreadsheet not found. Please verify the spreadsheet ID.";
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
            });
        }
    </script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
</body>
</html>
